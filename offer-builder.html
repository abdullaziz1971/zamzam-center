<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ØµØ§Ù†Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ¶ â€” ÙˆØµÙ Ø¹Ø±Ø¨ÙŠ â‡¢ JSON</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#facc15;--bg:#0b1220;--card:#ffffff;--muted:#6b7280;--b:#e5e7eb;--ok:#111827;
  }
  *{box-sizing:border-box}
  body{font-family:'Tajawal',system-ui,Segoe UI,Arial;background:#f7f7f9;margin:0;color:#111827}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--bg);color:#fff}
  header .brand{font-weight:800;letter-spacing:.3px}
  header .brand .accent{color:var(--gold)}
  main{max-width:1100px;margin:20px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px}
  h2{margin:.2rem 0 1rem;font-size:1.05rem}
  label{display:block;margin:.45rem 0 .3rem;font-weight:600}
  input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-family:inherit}
  textarea{min-height:92px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hint{font-size:.9rem;color:#374151;margin:.4rem 0 .6rem}
  .pill{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 10px;margin:3px 4px 0 0;font-size:.83rem}
  button.primary{background:var(--ok);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  button.ghost{background:#fff;border:1px solid #d1d5db;border-radius:10px;padding:8px 10px;margin-inline-start:6px;cursor:pointer}
  .out{white-space:pre-wrap;background:#0b1220;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto;min-height:140px}
  .stack{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .muted{color:var(--muted);font-size:.88rem}
  .line{height:1px;background:#e6e8ee;margin:12px 0}
  .badge{display:inline-block;background:#fff7ed;color:#9a3412;border:1px dashed #fdba74;border-radius:999px;padding:2px 9px;font-size:.77rem;margin-inline-start:6px}
  .footer-note{font-size:.86rem;color:#4b5563;margin-top:10px}
  .small{font-size:.86rem}
</style>
</head>
<body>
<header>
  <div class="brand">Ù„ÙˆØ­Ø© Ø²Ù…Ø²Ù… â€” <span class="accent">ØµØ§Ù†Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ¶</span></div>
  <div class="muted">v1.0 â€” Ù…Ù…ÙŠØ²/Ø¯Ù…Ø¬/Ø´Ø±ÙƒØ§Øª</div>
</header>

<main>
  <div class="grid">
    <!-- LEFT: Input form -->
    <section class="card">
      <h2>Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</h2>

      <label>Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ù…Ø®ØªØµØ±</label>
      <textarea id="txt" placeholder="Ù…Ø«Ø§Ù„: 3+1 Ø£ÙˆÙ„ÙˆÙŠØ² Ù…Ø§ÙƒØ³ÙŠ 16 Ø­Ø¨Ø© â€” ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ† â€” 9.75 Ø¯"></textarea>

      <div class="row">
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶</label>
          <select id="kind">
            <option value="featured">Ø¹Ø±Ø¶ Ù…Ù…ÙŠØ² (featuredOffers.items)</option>
            <option value="merge-strong">Ø¯Ù…Ø¬ Ù‚ÙˆÙŠ (mergedOffers.strong)</option>
            <option value="merge-free">Ø¯Ù…Ø¬ Ø­Ø± (mergedOffers.free)</option>
            <option value="company">Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ© (companies[].products)</option>
          </select>
        </div>
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="expires" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ø³Ø¹Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="price" type="text" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 9.75">
        </div>
        <div>
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <input id="currency" type="text" value="JD">
        </div>
      </div>

      <div class="line"></div>

      <h2 style="display:flex;align-items:center;gap:8px">
        Ø±Ø¨Ø· Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª
        <span id="dsLoaded" class="badge" title="ÙŠØ­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© /data.js Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª">ÙŠØ­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© /data.js</span>
      </h2>

      <div class="row">
        <div>
          <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© (Ø¥Ø°Ø§ ØªÙˆÙØ±Øª)</label>
          <select id="companySelect">
            <option value="">â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ / Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€”</option>
          </select>
        </div>
        <div>
          <label>Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© ÙŠØ¯ÙˆÙŠÙ‹Ø§</label>
          <input id="companyName" type="text" placeholder="Ù…Ø«Ø§Ù„: Petra / Ariel / Always ...">
        </div>
      </div>

      <div class="hint">
        ğŸ“ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©:
        <span class="pill">â€œ3+1â€ â‡’ bonus {buy,get}</span>
        <span class="pill">â€œÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†/Ø§Ù„Ø®Ù…ÙŠØ³/Ø§Ù„Ø³Ø¨Øªâ€¦â€ â‡’ expiry.weekday</span>
        <span class="pill">â€œ48Ø­/12Ø­/ÙƒØ±ØªÙˆÙ†Ø©/Ø¯Ø²ÙŠÙ†Ø©/Ø¨Ø§ÙƒÙŠØªâ€ â‡’ ØªØ¹Ø¨Ø¦Ø©/ÙˆØ­Ø¯Ø©</span>
        <span class="pill">â€œ9.75 Ø¯/Ø¯ÙŠÙ†Ø§Ø±/JDâ€ â‡’ price</span>
      </div>

      <div class="stack">
        <button class="primary" id="btnBuild">Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ JSON</button>
        <button class="ghost" id="btnClear">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>
      <div class="footer-note">Ù†ØµÙŠØ­Ø©: Ø§ÙƒØªØ¨ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„ÙˆØµÙ ÙƒØ§Ù…Ù„Ù‹Ø§ Ø«Ù… Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù„Ùˆ Ø£Ø±Ø¯Øª.</div>
    </section>

    <!-- RIGHT: Output -->
    <section class="card">
      <h2>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
      <div class="copy-wrap" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="ghost small" id="btnCopyObj">Ù†Ø³Ø® JSON</button>
        <button class="ghost small" id="btnCopyPath">Ù†Ø³Ø® Ø³Ø·Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬</button>
        <button class="ghost small" id="btnDownload">ØªÙ†Ø²ÙŠÙ„ ÙƒÙ…Ù„Ù .json</button>
        <span class="muted">Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ <b>data.json</b> (Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø³Ø·Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬).</span>
      </div>
      <pre id="out" class="out">{}</pre>

      <h2 style="margin-top:10px">Ø³Ø·Ø± Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ù‚ØªØ±Ø­</h2>
      <pre id="path" class="out">featuredOffers.items.push(â€¦)</pre>

      <div class="hint">
        âœ”ï¸ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø£Ù‚Ø³Ø§Ù…:
        <span class="pill">featuredOffers.items</span>
        <span class="pill">mergedOffers.strong</span>
        <span class="pill">mergedOffers.free</span>
        <span class="pill">companies[i].products</span>
      </div>
    </section>
  </div>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);

  const txt = $('#txt');
  const kind = $('#kind');
  const expires = $('#expires');
  const priceEl = $('#price');
  const currency = $('#currency');
  const out = $('#out');
  const path = $('#path');
  const selCompany = $('#companySelect');
  const companyName = $('#companyName');
  const dsLoaded = $('#dsLoaded');

  // ============== Helpers ==============
  const weekdaysMap = {
    'Ø§Ù„Ø³Ø¨Øª':'saturday','Ø§Ù„Ø£Ø­Ø¯':'sunday','Ø§Ù„Ø§Ø­Ø¯':'sunday','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†':'monday','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†':'monday',
    'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡':'tuesday','Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡':'wednesday','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡':'wednesday','Ø§Ù„Ø®Ù…ÙŠØ³':'thursday','Ø§Ù„Ø¬Ù…Ø¹Ø©':'friday'
  };

  function parseBonus(s){
    const m = s.match(/(\d+)\s*\+\s*(\d+)/);
    return m ? {buy:+m[1], get:+m[2]} : null;
  }
  function detectWeekday(s){
    for(const k in weekdaysMap){
      if(s.includes(k)) return weekdaysMap[k];
    }
    return null;
  }
  function detectPrice(s){
    const m = s.match(/(\d+(?:[.,]\d+)?)(?=\s*(?:Ø¯|Ø¯ÙŠÙ†Ø§Ø±|JD))/i);
    return m ? +m[1].replace(',','.') : null;
  }
  function detectPackaging(s){
    // returns [{label, pack}] e.g. [{label:'Ø­Ø¨Ø©',pack:16},{label:'ÙƒØ±ØªÙˆÙ†Ø©',pack:null}]
    const packs = [];
    let mm;
    let reQty = /(\d+)\s*Ø­(?:Ø¨|Ø¨Ø©)?/g; // 48Ø­ / 16 Ø­Ø¨Ø©
    while((mm = reQty.exec(s))){ packs.push({label:'Ø­Ø¨Ø©', pack:+mm[1]}); }
    // named units
    const units = [
      {re:/ÙƒØ±ØªÙˆÙ†Ø©|ÙƒØ±ØªÙˆÙ†/g, label:'ÙƒØ±ØªÙˆÙ†Ø©'},
      {re:/Ø¨Ø§ÙƒÙŠØª|Ø¨ÙƒÙŠØª/g, label:'Ø¨Ø§ÙƒÙŠØª'},
      {re:/Ø¯Ø²ÙŠÙ†Ø©|Ø¯Ø²/g, label:'Ø¯Ø²ÙŠÙ†Ø©'},
      {re:/Ø­Ø²Ù…Ø©|Ø±Ø¨Ø·Ø©/g, label:'Ø­Ø²Ù…Ø©'}
    ];
    units.forEach(u=>{
      if(u.re.test(s)) packs.push({label:u.label, pack:null});
      u.re.lastIndex = 0;
    });
    // de-dup
    const seen = new Set();
    return packs.filter(x=>{
      const k = x.label+'|'+(x.pack??'');
      if(seen.has(k)) return false;
      seen.add(k); return true;
    });
  }
  function titleFrom(s){
    let t = s.replace(/\d+\s*\+\s*\d+/,''); // remove 3+1
    t = t.replace(/ÙŠÙ†ØªÙ‡ÙŠ\s+\S+/,'');
    t = t.replace(/(\d+(?:[.,]\d+)?)\s*(?:Ø¯|Ø¯ÙŠÙ†Ø§Ø±|JD)/i,'');
    t = t.replace(/[â€”\-â€“]+/g,' ');
    return t.replace(/\s{2,}/g,' ').trim();
  }
  function composeDescription(unit, pack){
    const parts = [];
    if(unit) parts.push(unit);
    if(pack) parts.push('ØªØ¹Ø¨Ø¦Ø© '+pack);
    return parts.filter(Boolean).join(' â€” ');
  }
  function randId(prefix){ return prefix + '_' + Math.random().toString(36).slice(2,8); }

  // ============== Build ==============
  function build(){
    const s = (txt.value||'').trim();
    if(!s){ out.textContent='{}'; path.textContent='â€”'; return; }

    const bonus = parseBonus(s);
    const weekday = detectWeekday(s);
    const detectedPrice = detectPrice(s);
    const packs = detectPackaging(s);
    const t = titleFrom(s) || s;

    const chosenPrice = priceEl.value ? +priceEl.value.replace(',','.') : (detectedPrice ?? null);
    const cur = (currency.value||'JD').trim();

    // Basic object (common)
    const obj = {
      id: randId('offer'),
      title: t,
      description: s
    };
    if (chosenPrice!=null && !Number.isNaN(chosenPrice)) {
      obj.price = chosenPrice;
      obj.currency = cur;
    }
    if (bonus) obj.bonus = bonus;

    // expiry
    const exp = {};
    if (expires.value) exp.date = expires.value;
    if (weekday) exp.weekday = weekday;
    if (Object.keys(exp).length) obj.expiry = exp;

    // try to extract packaging/unit for description & variants
    if (packs.length){
      const firstNumeric = packs.find(p=>p.pack!=null);
      const firstUnit = packs[0]?.label || null;
      const mainUnit = firstNumeric ? 'Ø­Ø¨Ø©' : firstUnit;
      const mainPack = firstNumeric ? firstNumeric.pack : null;

      if (mainUnit) obj.unit = mainUnit;
      if (mainPack!=null) obj.packaging = String(mainPack);

      obj.variants = packs.map((p,i)=>({
        id: obj.id+'_v'+(i+1),
        label: p.label + (p.pack ? (' ØªØ¹Ø¨Ø¦Ø© '+p.pack) : ''),
        packaging: p.pack ?? null
      }));

      if (!obj.description || obj.description===s){
        const composed = composeDescription(obj.unit, obj.packaging);
        if (composed) obj.description = obj.title + ' â€” ' + composed;
      }
    }

    const k = kind.value;
    let suggested = 'featuredOffers.items.push(OBJ);';
    if (k==='merge-strong') suggested = 'mergedOffers.strong.push(OBJ);';
    if (k==='merge-free')   suggested = 'mergedOffers.free.push(OBJ);';

    // ==== Company Offer special mapping ====
    if (k==='company'){
      const selectedIdx = selCompany.value ? parseInt(selCompany.value,10) : null;
      const typedName = (companyName.value||'').trim();
      if (selectedIdx!=null && !Number.isNaN(selectedIdx)){
        obj.companyId = window.__COMPANIES?.[selectedIdx]?.id || undefined;
        obj.companyName = window.__COMPANIES?.[selectedIdx]?.name || undefined;
      } else if (typedName){
        obj.companyName = typedName;
      }

      // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø³ÙƒÙŠÙ…Ù€Ø§ Ø§Ù„Ø´Ø±ÙƒØ§Øª (u1_* Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„ÙƒÙ†Ù‡Ø§ Ù…ÙÙŠØ¯Ø© Ù„Ù„ÙˆØ­Ø©)
      if (obj.unit)  obj.u1_unit = obj.unit;
      if (obj.packaging!=null) obj.u1_pack = obj.packaging;
      if (obj.price!=null) obj.u1_price = obj.price;

      // ÙˆØµÙ Ù…ÙˆØ­Ù‘Ø¯: "Ø§Ù„ÙˆØ­Ø¯Ø© â€” ØªØ¹Ø¨Ø¦Ø© X"
      const unitTxt = (obj.unit||'').trim();
      const packTxt = (obj.packaging||'')?.toString().trim();
      const desc = [unitTxt, packTxt ? ('ØªØ¹Ø¨Ø¦Ø© '+packTxt) : ''].filter(Boolean).join(' â€” ');
      if (desc) obj.description = desc;

      suggested = 'companies[COMPANY_INDEX].products.push(OBJ);';
    }

    out.textContent = JSON.stringify(obj, null, 2);
    path.textContent = suggested.replace('OBJ', JSON.stringify(obj));
  }

  // ============== Data.js loader (optional) ==============
  (function loadDataJS(){
    const s = document.createElement('script');
    s.src = '/data.js?v=' + Date.now();
    s.defer = true;
    s.onload = function(){
      try{
        const D = window.ZAMZAM_DATA || window.DATA || window.data || window.ZamzamData;
        const companies = (D && D.companies) ? D.companies : null;
        if (companies && companies.length){
          window.__COMPANIES = companies;
          selCompany.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© â€”</option>';
          companies
            .map((c,idx)=>({name:c.name||c.title||c.id||('Ø´Ø±ÙƒØ© '+(idx+1)), id:c.id||null, idx}))
            .sort((a,b)=> a.name.localeCompare(b.name,'ar'))
            .forEach(o=>{
              const opt = document.createElement('option');
              opt.value = String(o.idx);
              opt.textContent = o.name;
              selCompany.appendChild(opt);
            });
          dsLoaded.textContent = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ù† /data.js';
          dsLoaded.style.background = '#ecfdf5';
          dsLoaded.style.color = '#065f46';
          dsLoaded.style.border = '1px solid #a7f3d0';
        }else{
          dsLoaded.textContent = 'Ù„Ù… ØªÙÙƒØªØ´Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª â€” Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…ØªØ§Ø­';
        }
      }catch(e){
        dsLoaded.textContent = 'ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© /data.js â€” Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…ØªØ§Ø­';
      }
    };
    s.onerror = function(){
      dsLoaded.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ /data.js â€” Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…ØªØ§Ø­';
    };
    document.head.appendChild(s);
  })();

  // ============== Events ==============
  $('#btnBuild').addEventListener('click', build);
  $('#btnClear').addEventListener('click', ()=>{
    txt.value=''; priceEl.value=''; expires.value=''; companyName.value=''; selCompany.value='';
    out.textContent='{}'; path.textContent='â€”';
  });
  $('#btnCopyObj').addEventListener('click', ()=>{
    navigator.clipboard.writeText(out.textContent||'{}');
  });
  $('#btnCopyPath').addEventListener('click', ()=>{
    navigator.clipboard.writeText(path.textContent||'');
  });
  $('#btnDownload').addEventListener('click', ()=>{
    const blob = new Blob([out.textContent||'{}'], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'offer.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

})();
</script>
</body>
</html>
