<?php declare(strict_types=1); header('Content-Type: application/json; charset=utf-8'); const GEN_SECRET='abc123TEST'; $s=$_GET['secret']??''; if($s!==GEN_SECRET){ http_response_code(401); echo json_encode(['error'=>'unauthorized']); exit; } $doc=rtrim($_SERVER['DOCUMENT_ROOT']??__DIR__,'/'); $base=dirname($doc); $jsonPath=$base.'/admin_v2/data.json'; $jsPath=$doc.'/data.js'; $tmp=$doc.'/.data.js.tmp'; $json=@file_get_contents($jsonPath); if($json===false){ http_response_code(500); echo json_encode(['error'=>'read_data_json_failed','path'=>$jsonPath]); exit; } $arr=json_decode($json,true); if(!is_array($arr)){ http_response_code(500); echo json_encode(['error'=>'data_json_invalid']); exit; } $payload='// Auto-generated '.date('c')."\nconst DATA = ".$json.";\n"; $fp=@fopen($tmp,'wb'); if(!$fp){ http_response_code(500); echo json_encode(['error'=>'tmp_open_failed']); exit; } if(!flock($fp,LOCK_EX)){ fclose($fp); @unlink($tmp); http_response_code(500); echo json_encode(['error'=>'tmp_lock_failed']); exit; } $w=fwrite($fp,$payload); fflush($fp); flock($fp,LOCK_UN); fclose($fp); if($w===false){ @unlink($tmp); http_response_code(500); echo json_encode(['error'=>'tmp_write_failed']); exit; } if(!@rename($tmp,$jsPath)){ @unlink($tmp); http_response_code(500); echo json_encode(['error'=>'atomic_rename_failed']); exit; } @chmod($jsPath,0644); echo json_encode(['ok'=>true,'updated'=>'/public_html/data.js','bytes'=>strlen($payload)]);